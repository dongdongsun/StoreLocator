<!doctype html>
<head>
<meta charset=utf-8>
<title>Regular go to places in bay area</title>

<meta name=keywords content="South bay, zen center, tennis court, pingpong club, restaurant">
<meta name=HandheldFriendly content=True>
<meta name=MobileOptimized content=320>
<meta name=viewport content="width=device-width, initial-scale=1.0">
<style type="text/css">
  html { height: 100% }
  body { height: 100%; margin: 0; padding: 0 ;background-color:rgb(230,230,230);}
  #map_canvas { height: 100% }
  #input_canvas {margin: 100px,50px;border-style:solid;border-width:medium;border-color:rgb(100,100,100);padding:15px 25px 15px 100px; }
  #infowindow {background-color:rgb(240,240,240);border-style:groove;border-width:small;border-color:rgb(200,200,200);}
  #labelLine {font-family:"Arial";font-size:17px;font-weight:bold;font-color:rgb(150,150,150);padding:3px,0px,3px,0px}
  #inlineText {font-family:"Arial";font-size:16px;}
  #infoWindowText {font-family:"Arial";font-size:13px;} 
</style>

<!--link href="assets/css/min.css" rel=stylesheet-->
<script type="text/javascript"
 src="http://maps.googleapis.com/maps/api/js?key=AIzaSyAcJTgE4gZPnnjFiQ2zgWYshFDaxRcXFJ8&sensor=false&libraries=panoramio">
</script>

<script src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script>

<script type="text/javascript">
  var map ;
  var geocoder;
  var marker;
  var infowindow;
  var trafficLayer ;
  var bikeLayer;
  var fusionLayer;
  var panoramioLayer;
  var homeLatLng;
  //https://www.google.com/fusiontables/DataSource?docid=1gnZV06Lk6tbpUrhvWujGYTLLHWfQZW7F07XBlXU
  // var tableId = '1OHhO6tT83GERB31_2gJHH2W5OQv_KxGQeLj_IYc'; //fusion table id for dongdongsun2008
  //var tableId = '1gnZV06Lk6tbpUrhvWujGYTLLHWfQZW7F07XBlXU'; //fusion table id for dongsun
  //  var myKey = 'AIzaSyBlro9jUDsZRWKlQhXWnUTWrdW2seRPfFY'; 
  //var myKey ='AIzaSyDYlfqxc8jRB8oaoPkT9sY8uIc1d0axdfY'; //API key for API console project SDGeoProject
 var clientId = '96815552604.apps.googleusercontent.com'; //dongdongsun2008
 var myKey = 'AIzaSyAcJTgE4gZPnnjFiQ2zgWYshFDaxRcXFJ8';
 var tableId = '1OHhO6tT83GERB31_2gJHH2W5OQv_KxGQeLj_IYc';

 // To enter one or more authentication scopes, refer to the documentation for the API.
 var scopes = 'https://www.googleapis.com/auth/fusiontables';

  function initialize() {
	
//	https://www.google.com/fusiontables/DataSource?docid=1gnZV06Lk6tbpUrhvWujGYTLLHWfQZW7F07XBlXU
//	var tableId = '1gnZV06Lk6tbpUrhvWujGYTLLHWfQZW7F07XBlXU'; //fusion table id for dongsun
    homeLatLng = new google.maps.LatLng(37.4218, -122.0840);  //home lat long
    
    var myOptions = {
        center: homeLatLng,
        zoom: 11,
        mapTypeId: google.maps.MapTypeId.ROADMAP
    };

    //init map obj        
    map = new google.maps.Map(document.getElementById("map_canvas"),  myOptions);
    
    //add home control to center the map on base location
    var homeControlDiv = document.createElement('div');
    var homeControl = new HomeControl(homeControlDiv, map);

    homeControlDiv.index = 1;
    map.controls[google.maps.ControlPosition.TOP_RIGHT].push(homeControlDiv);
  
    //add fusion table layer      
    fusionLayer = new google.maps.FusionTablesLayer();  
      
    //add traffic layer and set it on
    trafficLayer = new google.maps.TrafficLayer();
    trafficLayer.setMap(map);
    
    //add bike layer
    bikeLayer = new google.maps.BicyclingLayer();
       
    //add panoramio layer and set it on
    panoramioLayer = new google.maps.panoramio.PanoramioLayer();
    //panoramioLayer.setTag('');
                
    geocoder = new google.maps.Geocoder();
    infowindow = new google.maps.InfoWindow();

 
   //add fusion table to the map with style    
    filterMap(fusionLayer, tableId, map);
    
    //register event handler when user check or uncheck check boxes showing different categories of places in the fusion table
    google.maps.event.addDomListener(document.getElementById('Tennis'),'click', function() {
          filterMap(fusionLayer, tableId, map);
    });

    google.maps.event.addDomListener(document.getElementById('Hiking'),'click', function() {
          filterMap(fusionLayer, tableId, map);
    });

    google.maps.event.addDomListener(document.getElementById('Food'),'click', function() {
          filterMap(fusionLayer, tableId, map);
    });
    
    google.maps.event.addDomListener(document.getElementById('Pingpong'),'click', function() {
          filterMap(fusionLayer, tableId, map);
    });

    google.maps.event.addDomListener(document.getElementById('Zen'),'click', function() {
              filterMap(fusionLayer, tableId, map);
    });
    
    //register event handler when user toggles traffic layer, bike layer and panoramio layer 
    google.maps.event.addDomListener(document.getElementById('Traffic'),'click', function() {
              showLayer(trafficLayer);
    });
    google.maps.event.addDomListener(document.getElementById('BikeLayer'),'click', function() {
              showLayer(bikeLayer);
    });
    google.maps.event.addDomListener(document.getElementById('Panoramio'),'click', function() {
              showLayer(panoramioLayer);
    });
    
    //register event handler to do reverse geocoding. It is triggered when user left clicks on map, and reseult will be showen in an infoWindow
    google.maps.event.addListener(map, 'click', function(event) {
        reverseGeocoding(event.latLng);
    });
   
    // Generate a where clause from the checkboxes to do fusion table data selection. If no boxes are checked, return an empty string.
    function generateWhere() {
      var filter = [];
      var categories = document.getElementsByName('categories');
      for (var i = 0, category; category = categories[i]; i++) {
        if (category.checked) {
        var categoryName = category.value  ;
          filter.push("'" + categoryName + "'");
        }
      }
      var where = '';
      if (filter.length) {
        where = "'Category' in (" + filter.join(',') + ')';
      }
      return where;
    }

    // Display place categories with different marker icons. 
    function filterMap() {
      var where = generateWhere();
     
      if (where) {
        if (!fusionLayer.getMap()) {
          fusionLayer.setMap(map);
        }
        fusionLayer.setOptions({
          query: {
            where: where,
            select: 'Address',
            from: tableId
          },styles: [
              {
                where: 'Category = \'Hiking place\'',
                markerOptions: {
                  iconName: "parks"
                }
              },
              {
                  where: 'Category = \'Food\'',
                  markerOptions: {
                    iconName: "dining"
                  }
              },
              {
                  where: 'Category in (\'Pingpong club\',\'Tennis court\')',
                  markerOptions: {
                    iconName: "play"
                  }
              },
              {
                  where: 'Category = \'Zen place\'',
                  markerOptions: {
                    iconName: "buildings"
                  }
              }
            ]
          
        });
      } else {
        fusionLayer.setMap(null);
      }
    } 
    
  }//init

  //defines home control so we could always center the map back to the base point
  function HomeControl(controlDiv, map) {

  // Set CSS styles for the DIV containing the control
  // Setting padding to 5 px will offset the control
  // from the edge of the map
  controlDiv.style.padding = '5px';

  // Set CSS for the control border
  var controlUI = document.createElement('div');
  controlUI.style.backgroundColor = 'white';
  controlUI.style.borderStyle = 'solid';
  controlUI.style.borderWidth = '2px';
  controlUI.style.cursor = 'pointer';
  controlUI.style.textAlign = 'center';
  controlUI.title = 'Click to set the map to (37.4218, -122.0840)';
  controlDiv.appendChild(controlUI);

  // Set CSS for the control interior
  var controlText = document.createElement('div');
  controlText.style.fontFamily = 'Arial,sans-serif';
  controlText.style.fontSize = '12px';
  controlText.style.paddingLeft = '4px';
  controlText.style.paddingRight = '4px';
  controlText.innerHTML = '<b>Home</b>';
  controlUI.appendChild(controlText);

  // Setup the click event listeners: simply set the map to home
  google.maps.event.addDomListener(controlUI, 'click', function() {
    map.setCenter(homeLatLng)
  });

 }

  //toggle layers including bike layer, fusion table layer and traffic layer. 
  function showLayer(layer){
    if (!layer.getMap()) {
        layer.setMap(map);
      }
      else
        layer.setMap(null);
  }
  
  //handles reverse geocoding. When user left click anywhere on the map, trigger
   function reverseGeocoding(latlng) {
     try{
        //map.clearOverlays();
        geocoder.geocode({'latLng': latlng}, function(results, status) {
          if (status == google.maps.GeocoderStatus.OK) {
            if (results[0]) {
              if (marker == null) {
                marker = new google.maps.Marker({
                    position: latlng,
                    map: map
                });
                 }
               else
                 {marker.setPosition(latlng);}
                  
              innerHTMLContent = '<div id ="infowindow"><p id ="infoWindowText">'+ results[0].formatted_address+ '</p>\n' +'<div>';
              infowindow.setContent(innerHTMLContent);
           
           //   google.maps.event.addListener(infowindow, 'domready', function() {
           //       document.id("RouteForm").addEvent("submit", calcRoute());
           //   });

              infowindow.open(map, marker);
            }
          } else {
            alert("Geocoder failed due to: " + status);
          }
        });
      }
      catch(err){
        txt="Error in ReverseGeocoding.\n\n";
        txt+="Error message: " + err.message + "\n\n";
        alert(txt);
      }
    }
 
  
  function codeAddress() {
    var address = document.getElementById("address").value;
    try {
      geocoder.geocode( {'address': address}, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
          
          map.setCenter(results[0].geometry.location);
          
          if (marker == null) {
            marker = new google.maps.Marker({
                position: results[0].geometry.location,
                map: map
            });
          }
          else
            {marker.setPosition(results[0].geometry.location);}
          innerHTMLContent = '<div id ="infowindow"><p id ="infoWindowText">'+ results[0].formatted_address+ '</p>\n' +'<div>';
          infowindow.setContent(innerHTMLContent);
          infowindow.open(map, marker);
        } else {
          alert("Geocode was not successful for the following reason: " + status);
        }
      });
    }     
    catch(err){
        txt="Error in ReverseGeocoding.\n\n";
        txt+="Error message: " + err.message + "\n\n";
        alert(txt);
    }
  }
           
   // google.maps.event.addDomListener(window, 'load', initialize);
 
 

	//google.maps.event.addDomListener(window, 'load', initialize);
	function handleClientLoad() {
        gapi.client.setApiKey(apiKey);
        window.setTimeout(checkAuth,1);
      }

	 function checkAuth() {
        gapi.auth.authorize({client_id: clientId, scope: scopes, immediate: true}, handleAuthResult);
      }
		
	function handleAuthResult(authResult) {
		// console.log(authResult);  //returns access token with expire time setting 3600
        var authorizeButton = document.getElementById('authorize-button');
        if (authResult && !authResult.error) {
          authorizeButton.style.visibility = 'hidden';
          google.maps.event.addDomListener(window, 'load', initialize);
        } else {
          authorizeButton.style.visibility = '';
          authorizeButton.onclick = handleAuthClick;
        }
      }
	
	function APIQuery(){
		var url = ['https://www.googleapis.com/fusiontables/v1/query?'];
		        url.push('sql=');
		        var query = 'SELECT name, address FROM ' + tableId;
		        var encodedQuery = encodeURIComponent(query);
		        url.push(encodedQuery);
		        url.push('&callback=drawMap');
		        url.push('&key='+myKey); //see https://code.google.com/apis/console/?pli=1#project:672184603222
				url: url.join('');
	}
	
	function drawMap(data) {
	//	console.log(response);
		alert("hi");
	  	alert(data);
      /*var rows = data['rows'];
      for (var i in rows) {
        if (rows[i][0] != 'Antarctica') {
          var newCoordinates = [];
          var geometries = rows[i][1]['geometries'];
          if (geometries) {
            for (var j in geometries) {
              newCoordinates.push(constructNewCoordinates(geometries[j]));
            }
          } else {
            newCoordinates = constructNewCoordinates(rows[i][1]['geometry']);
          }
          var randomnumber = Math.floor(Math.random() * 4);
          var country = new google.maps.Polygon({
            paths: newCoordinates,
            strokeColor: colors[randomnumber],
            strokeOpacity: 0,
            strokeWeight: 1,
            fillColor: colors[randomnumber],
            fillOpacity: 0.3
          });
          google.maps.event.addListener(country, 'mouseover', function() {
            this.setOptions({fillOpacity: 1});
          });
          google.maps.event.addListener(country, 'mouseout', function() {
            this.setOptions({fillOpacity: 0.3});
          });

          country.setMap(map);
        }
      } */
    }
    
	
    </script>


  </head>
  
  <body >
    <div id="map_canvas" style="width:100%; height:80%"></div>
    <div id="input_canvas" >
     <label id ="labelLine">1. Where are they: </label>
     <input id="address" type="textbox" length = "250" value="Gloden gate bridge">
     <input type="button" value="Find out!" onclick="codeAddress()">

     <input type="button" value="Use FT API query" onclick="APIQuery()">
     <br/>
    
    <label id ="labelLine">2. My Regular Places</label> <br/>
    <input type="checkbox" checked="checked" name="categories" id="Tennis" value="Tennis court">
    <label id ="inlineText">Tennis</label>
    <input type="checkbox" checked="checked" name="categories" id="Pingpong" value="Pingpong club">
    <label id ="inlineText">Ping pong</label>
    <input type="checkbox" checked="checked" name="categories" id="Hiking" value="Hiking place">
    <label id ="inlineText">Hiking</label>
    <input type="checkbox" checked="checked" name="categories" id="Food" value="Food">
    <label id ="inlineText">Food</label>
    <input type="checkbox" checked="checked" name="categories" id="Zen" value="Zen place">    
    <label id ="inlineText">Zen places</label>
    <br>
    
    <label id ="labelLine">3. You might also want to see: </label><br/>
    <input type="checkbox" checked="checked" name="traffic" id="Traffic" value="Traffic">    
    <label id ="inlineText">Traffic</label>
    <input type="checkbox"  name="bike" id="BikeLayer" value="Bike">    
      <label id ="inlineText">Bike Layer</label>
    <input type="checkbox"  name="panoramioLayer" id="Panoramio" value="Panoramio">    
    <label id ="inlineText">Panoramio Layer</label>
    <br/>
      
   </div>
  </body>
</html>